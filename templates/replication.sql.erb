-- Generated by Chef for <%= node["hostname"] %>.
-- Local modifications will be overwritten.
CREATE USER IF NOT EXISTS '<%=node["percona"]["server"]["replication"]["username"]%>'@'%' IDENTIFIED BY '<%= @replication_password %>';
GRANT REPLICATION SLAVE ON *.* TO '<%=node["percona"]["server"]["replication"]["username"]%>'@'%';
<% if node["percona"]["server"]["replication"]["ssl_enabled"] -%>
ALTER USER '<%=node["percona"]["server"]["replication"]["username"]%>'@'%' REQUIRE SSL;
<% end -%>
FLUSH PRIVILEGES;
<% unless node["percona"]["server"]["replication"]["host"].empty? %>

CHANGE REPLICATION SOURCE TO
  SOURCE_HOST='<%= node["percona"]["server"]["replication"]["host"] %>',
  SOURCE_PORT=<%= node["percona"]["server"]["replication"]["port"] %>,
  SOURCE_USER='<%= node["percona"]["server"]["replication"]["username"] %>',
  <% if node["percona"]["server"]["replication"]["ssl_enabled"] %>
  SOURCE_SSL=1,
  SOURCE_SSL_CA='/etc/mysql/ssl/cacert.pem',
  <% if node['percona']['server']['role'].include?('replica') || node['percona']['server']['role'].include?('slave') %>
  SOURCE_SSL_CERT='/etc/mysql/ssl/client-cert.pem',
  SOURCE_SSL_KEY='/etc/mysql/ssl/client-key.pem',
  <% elsif node['percona']['server']['role'].include?('source') || node['percona']['server']['role'].include?('master') %>
  SOURCE_SSL_CERT='/etc/mysql/ssl/server-cert.pem',
  SOURCE_SSL_KEY='/etc/mysql/ssl/server-key.pem',
  <% end %>
  <% end %>
  SOURCE_PASSWORD='<%= @replication_password %>';
START REPLICA;
<% end %>
